generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ==========================
// AUTENTICACI√ìN / ROLES
// ==========================
model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?
  users       User[]
}

model User {
  id         Int      @id @default(autoincrement())
  first_name String
  last_name  String
  email      String   @unique
  password   String
  status     Boolean  @default(true)
  role_id    Int?
  role       Role?    @relation(fields: [role_id], references: [id])
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  Teacher           Teacher?
  Student           Student?
  institutionAdmins InstitutionAdmin[] // ‚úÖ Cambiado

  Logs        Log[]
  resetTokens PasswordResetToken[]
}

//
// ==========================
// INSTITUCI√ìN
// ==========================
model Institution {
  id      Int     @id @default(autoincrement())
  name    String
  code    String  @unique
  address String?
  email   String?
  phone   String?
  status  Boolean @default(true)

  // Relaciones acad√©micas
  teachers         Teacher[]
  students         Student[]
  plans            Plan[]
  academicPeriods  AcademicPeriod[] // La instituci√≥n define los periodos
  enrollmentSheets EnrollmentSheet[]
  faculties        Faculty[]
  programs         Program[] // ‚úÖ NUEVA RELACI√ìN: Indica que la instituci√≥n posee Programas
  // Administradores de la instituci√≥n (tabla de uni√≥n)
  admins           InstitutionAdmin[]
}

//
// ==========================
// INSTITUTION ADMIN (vincula usuarios con rol admin a una instituci√≥n)
// ==========================
model InstitutionAdmin {
  id             Int      @id @default(autoincrement())
  user_id        Int
  institution_id Int
  assigned_at    DateTime @default(now())

  user        User        @relation(fields: [user_id], references: [id])
  institution Institution @relation(fields: [institution_id], references: [id])

  @@unique([user_id, institution_id])
}

//
// ==========================
// GESTI√ìN DE PERIODOS ACAD√âMICOS
// ==========================
// ==========================
// GESTI√ìN DE PERIODOS ACAD√âMICOS
// ==========================
model AcademicPeriod {
  id             Int      @id @default(autoincrement())
  institution_id Int
  year           Int
  name           String // Ej: "2025 - I Semestre"
  modality       String // NUEVO CAMPO: "Bimestre", "Semestre", "M√≥dulo", etc.
  start_date     DateTime
  end_date       DateTime
  is_active      Boolean  @default(true)

  institution Institution @relation(fields: [institution_id], references: [id])

  assignments      Assignment[]
  admissions       AdmissionProcess[]
  enrollmentSheets EnrollmentSheet[]

  @@unique([institution_id, year, name])
}

//
// ==========================
// PLAN DE ESTUDIOS (VERSIONADO CURRICULAR)
// ==========================
model Plan {
  id             Int         @id @default(autoincrement())
  title          String // Ej: "Plan Curricular 2024 (Vigente)"
  description    String?
  start_year     Int
  end_year       Int
  status         Boolean     @default(true)
  institution_id Int
  institution    Institution @relation(fields: [institution_id], references: [id])

  // Relaci√≥n con Programas (versiones de carrera)
  programs Program[]
}

//
// ==========================
// CAT√ÅLOGOS ACAD√âMICOS
// ==========================

// üö® SCHEMA CORREGIDO (A√ëADIR V√çNCULO LOCAL)
model Faculty {
  id          Int     @id @default(autoincrement())
  name        String
  description String?

  // üéØ V√çNCULO CRUCIAL A LA INSTITUCI√ìN
  institution_id Int
  institution    Institution @relation(fields: [institution_id], references: [id])

  programs Program[]

  // El nombre debe ser √∫nico S√ìLO dentro de la instituci√≥n
  @@unique([institution_id, name])
}

model Program {
  id             Int     @id @default(autoincrement())
  institution_id Int
  faculty_id     Int
  plan_id        Int
  name           String
  description    String?
  duration_months         Int?                // <-- A√ëADIDO: Meses exactos
  duration_years          Int                 // A√±os calculados (requerido previamente)
  is_active               Boolean             @default(true) // <-- A√ëADIDO: Estado de actividad

  faculty          Faculty           @relation(fields: [faculty_id], references: [id])
  institution      Institution       @relation(fields: [institution_id], references: [id]) // <-- NUEVA RELACI√ìN
  plan             Plan              @relation(fields: [plan_id], references: [id])
  courses          Course[]
  enrollments      Enrollment[]
  enrollmentSheets EnrollmentSheet[]
}

model Course {
  id         Int    @id @default(autoincrement())
  program_id Int
  code       String @unique
  name       String
  credits    Int
  semester   Int // Semestre en que se imparte seg√∫n el curr√≠culo

  program           Program            @relation(fields: [program_id], references: [id])
  assignments       Assignment[]
  enrollmentCourses EnrollmentCourse[]
}

//
// ==========================
// GESTI√ìN ACAD√âMICA
// ==========================
model Teacher {
  id             Int       @id @default(autoincrement())
  user_id        Int       @unique
  institution_id Int
  specialization String?
  hire_date      DateTime?

  user        User         @relation(fields: [user_id], references: [id])
  institution Institution  @relation(fields: [institution_id], references: [id])
  assignments Assignment[]
}

model Student {
  id              Int     @id @default(autoincrement())
  user_id         Int     @unique
  institution_id  Int
  enrollment_year Int?
  status          Boolean @default(true)

  user        User         @relation(fields: [user_id], references: [id])
  institution Institution  @relation(fields: [institution_id], references: [id])
  enrollments Enrollment[]
  grades      Grade[]
}

model Assignment {
  id                 Int @id @default(autoincrement())
  course_id          Int
  teacher_id         Int
  academic_period_id Int
  //CAMPO A√ëADIDO: Para definir el turno del grupo (Ma√±ana, Tarde, Noche)
  shift               String
  course         Course         @relation(fields: [course_id], references: [id])
  teacher        Teacher        @relation(fields: [teacher_id], references: [id])
  academicPeriod AcademicPeriod @relation(fields: [academic_period_id], references: [id])
  grades         Grade[]

  // Un curso solo se asigna a un profesor por periodo
  @@unique([course_id, academic_period_id, shift])
}

model Grade {
  id            Int     @id @default(autoincrement())
  student_id    Int
  assignment_id Int
  grade         Float?
  observation   String?

  student    Student    @relation(fields: [student_id], references: [id])
  assignment Assignment @relation(fields: [assignment_id], references: [id])

  @@unique([student_id, assignment_id])
}

//
// ==========================
// MATR√çCULA
// ==========================
model AdmissionProcess {
  id                 Int       @id @default(autoincrement())
  academic_period_id Int
  description        String?
  start_date         DateTime?
  end_date           DateTime?

  academicPeriod AcademicPeriod @relation(fields: [academic_period_id], references: [id])

  enrollments      Enrollment[]
  enrollmentSheets EnrollmentSheet[]
}

model Enrollment {
  id                   Int      @id @default(autoincrement())
  student_id           Int
  program_id           Int
  admission_process_id Int
  status               String   @default("preinscrito")
  enrolled_at          DateTime @default(now())

  student             Student               @relation(fields: [student_id], references: [id])
  program             Program               @relation(fields: [program_id], references: [id])
  admissionProcess    AdmissionProcess      @relation(fields: [admission_process_id], references: [id])
  enrollmentCourses   EnrollmentCourse[]
  EnrollmentSheetItem EnrollmentSheetItem[]
}

model EnrollmentCourse {
  id            Int    @id @default(autoincrement())
  enrollment_id Int
  course_id     Int
  status        String @default("activo")

  enrollment Enrollment @relation(fields: [enrollment_id], references: [id])
  course     Course     @relation(fields: [course_id], references: [id])

  @@unique([enrollment_id, course_id])
}

//
// ==========================
// HOJA DE MATR√çCULA (Registro Hist√≥rico)
// ==========================
model EnrollmentSheet {
  id                 Int @id @default(autoincrement())
  institution_id     Int
  program_id         Int
  admission_id       Int
  academic_period_id Int

  // Campos para registro hist√≥rico inmutable
  module_name  String
  class_period String
  shift        String
  section      String
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  institution    Institution           @relation(fields: [institution_id], references: [id])
  program        Program               @relation(fields: [program_id], references: [id])
  admission      AdmissionProcess      @relation(fields: [admission_id], references: [id])
  academicPeriod AcademicPeriod        @relation(fields: [academic_period_id], references: [id])
  items          EnrollmentSheetItem[]
}

model EnrollmentSheetItem {
  id                  Int @id @default(autoincrement())
  enrollment_sheet_id Int
  enrollment_id       Int

  // Registro hist√≥rico inmutable de la "Hoja de Matr√≠cula"
  student_name String
  sex          String
  birth_date   DateTime
  condition    String
  units        Int
  credits      Int

  enrollmentSheet EnrollmentSheet @relation(fields: [enrollment_sheet_id], references: [id])
  enrollment      Enrollment      @relation(fields: [enrollment_id], references: [id])
}

//
// ==========================
// LOGS Y AUDITOR√çA
// ==========================
model Log {
  id          Int      @id @default(autoincrement())
  user_id     Int
  action      String
  description String?
  created_at  DateTime @default(now())

  user User @relation(fields: [user_id], references: [id])
}

//
// ==========================
// RECUPERACI√ìN DE CONTRASE√ëA
// ==========================
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}
